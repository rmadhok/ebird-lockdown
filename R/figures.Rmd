---
title: "Manuscript Tables and Figur
author: "Raahil Madhok"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    number_sections: yes
  pdf_document: default
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir = '/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/data/')
```

```{r,include=F,warning=FALSE,message=FALSE}
# Load Packages
rm(list=ls())
require(tidyverse)
require(kableExtra)
require(lfe)
require(modelsummary)
source('/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/scripts/R/select_functions.R')
```

# Overview
Sample selection protocol:

1. Stationary and Travelling trips

2. Complete checklists (report all species)

3. Drop duplicates from group trips.

4. Drop trips with 1 bird

5. Duration between 5-240 mins

Notes:

1. We select cities first, and then users. This gives us the same users in each pre/post period (in 2020) with the caveat that users mobility is limited to the top X cities.  

2. Few people take stationary trips pre-lockdown.

## Birdwatching Activity Across All Cities and Users
Number of users is the count of unique user ID's active on a given day.  

```{r,include=F,warning=FALSE,message=FALSE}
# Read
ebird_full <- readRDS('ebd_full.rds')

# 24 days before and after lockdown (Mar 24 2020)
ebird <- ebird_full[ebird_full$YEAR == 2020 & 
                      ebird_full$OBSERVATION.DATE <= '2020-04-17',]
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=3,fig.width=8}
# Usage by Day
stats <- ebird %>%
  group_by(OBSERVATION.DATE, PROTOCOL.TYPE) %>%
  summarize(`Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
  gather(key, value, starts_with('N'))

ggplot(stats, aes(x=OBSERVATION.DATE, y=value, group=PROTOCOL.TYPE)) +
  geom_line(aes(color=PROTOCOL.TYPE)) + 
  labs(title = 'Birdwatching Activity in all Cities (2020)', y='') +
  geom_vline(xintercept=as.numeric(as.Date("2020-03-24")), linetype='dashed') +
  scale_x_date(date_breaks = '10 days', date_labels = '%b\n%d') +
  scale_colour_viridis_d() +
  labs(color='Trip Type') +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank()) +
  facet_wrap(~key, scales='free')
```

## Birdwatching Activity 4 Urban Centers

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=10,fig.width=8}
# By City
stats <- ebird %>%
  group_by(COUNTY, OBSERVATION.DATE, PROTOCOL.TYPE) %>%
  summarize(`Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
  gather(key, value, starts_with('N'))
stats <- filter(stats, COUNTY %in% c('Mumbai', 'Bangalore', 'Chennai', 'Kolkata'))

ggplot(stats, aes(x=OBSERVATION.DATE, y=value, group=PROTOCOL.TYPE)) +
  geom_line(aes(color=PROTOCOL.TYPE)) +
  labs(title = 'Birdwatching Activity in Four Major Cities (2020)', y='') +
  geom_vline(xintercept=as.numeric(as.Date("2020-03-24")), linetype='dashed') +
  scale_x_date(date_breaks = '10 days', date_labels = '%b\n%d') +
  scale_colour_viridis_d() +
  labs(color='Trip Type') +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank()) +
  facet_wrap(~COUNTY+key, scales='free', ncol=3)
```

## Top 20 Cities
Subset of top 20 cities in which users meeting participation constraint are present.  

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
ebird.d <- filter(ebird, OBSERVATION.DATE != '2020-03-22')
stats <- ebird.d %>%
  select_sample(num_cities = 20) %>%
  group_by(COUNTY) %>%
  summarize(STATE = first(STATE), POP_DENSITY = first(POP_DENSITY)) %>%
  arrange(-POP_DENSITY)

kable(stats, 
      caption = 'Subset of Top 20 Cities where power users present') %>% 
  kable_styling()
```

## Pre-Post Lockdown Statistics
This table shows birdwatching activity among users who took at least 2 trips before and after lockdown. Mar 22 trips are dropped.
```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# All Cities
stats <- ebird.d %>%
  select_sample() %>%
  mutate(PREPOST = if_else(
    OBSERVATION.DATE <= '2020-03-24', 'Before', 'After')
    ) %>%
  group_by(PREPOST) %>%
  summarize(`Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Cities` = n_distinct(COUNTY),
            `Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
  arrange(desc(PREPOST))

kable(stats, caption = 'All Cities') %>% kable_styling()

# Top 20
stats <- ebird.d %>%
  select_sample(num_cities = 20) %>%
  mutate(PREPOST = if_else(
    OBSERVATION.DATE <= '2020-03-24', 'Before', 'After')
    ) %>%
  group_by(PREPOST) %>%
  summarize(`Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Cities` = n_distinct(COUNTY),
            `Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
  arrange(desc(PREPOST))

kable(stats, caption = 'Top 20') %>% kable_styling()
```

## Trip Statistics
This table shows trip statistics before and after lockdown among users meeting the participation constraint.

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# All Cities
stats <- ebird.d %>%
  select_sample() %>%
  distinct(SAMPLING.EVENT.IDENTIFIER, .keep_all = T) %>%
  dplyr::select(OBSERVATION.DATE, SAMPLING.EVENT.IDENTIFIER, 
                DURATION.MINUTES, s_richness, COUNTY) %>%
  mutate(PREPOST = if_else(
    OBSERVATION.DATE <= '2020-03-24', 'Before', 'After')
    ) %>%
  group_by(PREPOST) %>%
  summarize(`Trip Length` = mean(DURATION.MINUTES, na.rm=T),
            `Mean Species Richness` = mean(s_richness, na.rm=T),
            `Median Species Richness` = median(s_richness, na.rm=T)) %>%
  arrange(desc(PREPOST))

kable(stats, caption='All Cities') %>% kable_styling()

# Top 20
stats <- ebird.d %>%
  select_sample(num_cities = 20) %>%
  distinct(SAMPLING.EVENT.IDENTIFIER, .keep_all = T) %>%
  dplyr::select(OBSERVATION.DATE, SAMPLING.EVENT.IDENTIFIER, 
                DURATION.MINUTES, s_richness, COUNTY) %>%
  mutate(PREPOST = if_else(
    OBSERVATION.DATE <= '2020-03-24', 'Before', 'After')
    ) %>%
  group_by(PREPOST) %>%
  summarize(`Trip Length` = mean(DURATION.MINUTES, na.rm=T),
            `Mean Species Richness` = mean(s_richness, na.rm=T),
            `Median Species Richness` = median(s_richness, na.rm=T)) %>%
  arrange(desc(PREPOST))

kable(stats, caption='Top 20') %>% kable_styling()

# By City
stats1 <- ebird.d %>%
  select_sample(num_cities = 20) %>% 
  mutate(label = 'All Trips')
stats2 <- ebird.d %>%
  filter(PROTOCOL.TYPE == 'Stationary') %>% 
  select_sample(num_cities=20) %>%
  mutate(label = 'Stationary Trips')
stats <- rbind(stats1, stats2)
rm(list=c('stats1','stats2'))

stats <- stats %>%  
  distinct(label, SAMPLING.EVENT.IDENTIFIER, .keep_all = T) %>%
  dplyr::select(OBSERVER.ID, OBSERVATION.DATE, SAMPLING.EVENT.IDENTIFIER, 
                DURATION.MINUTES, s_richness, COUNTY, label) %>%
  mutate(PREPOST = if_else(
    OBSERVATION.DATE <= '2020-03-24', 'Before', 'After')
    ) %>%
  group_by(label, COUNTY, PREPOST) %>%
  summarize(mean = mean(s_richness, na.rm=T),
            sd = sd(s_richness, na.rm=T),
            n = n(),
            se = sd/sqrt(n)) %>%
  filter(COUNTY %in% c('Bangalore', 'Chennai', 'Kolkata', 'Mumbai'))

ggplot(stats, aes(x=factor(label), 
                  y=mean, 
                  fill=forcats::fct_rev(PREPOST))) + 
  geom_bar(stat = 'identity', position='dodge') + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                position = position_dodge2(padding = 0.8)) +
  labs(title = 'Species Richness Per Trip Before and After Lockdown', 
       y='Mean Species Richness Per Trip',
       fill='') +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks = element_blank()) +
  facet_wrap(~COUNTY, scales = 'free')
```

## Marginal Species by city
Marginal species are species observed after lockdown which were not observed before lockdown. To implement: in each city, obtain list of species before and after lockdown observed by users meeting participation cosntraint. Extract species in "after" list not in "before" list.

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Species List
stats <- ebird.d %>% 
  filter(PROTOCOL.TYPE == 'Stationary') %>%
  select_sample(num_cities = 20, home = T)
stats$prepost <- if_else(stats$OBSERVATION.DATE <= '2020-03-24', 'PRE', 'POST')
city_list <- distinct(stats, COUNTY)$COUNTY
marginal_species <- data.frame()

# stack Marginal Species per city
for(city in city_list) {
  
  df_pre <- stats %>%
    filter(COUNTY == city & prepost == 'PRE') %>%
    distinct(TAXONOMIC.ORDER, .keep_all = T) %>%
    select('TAXONOMIC.ORDER','COMMON.NAME', 'SCIENTIFIC.NAME', 'COUNTY')

  df_post <- stats %>%
    filter(COUNTY == city & prepost == 'POST') %>%
    distinct(TAXONOMIC.ORDER, .keep_all = T) %>%
    select('TAXONOMIC.ORDER','COMMON.NAME', 'SCIENTIFIC.NAME', 'COUNTY')
  
  marginal <- anti_join(df_post, df_pre, by='TAXONOMIC.ORDER')
  marginal_species <- rbind(marginal_species, marginal)
}

kable(marginal_species) %>%
  kable_styling(fixed_thead = T)
rm(list=c('city_list', 'df_post', 'df_pre', 'marginal'))
```

# Event Study
We estimate:

$$ SR_{ijtd} = \sum_{e=-24, e\neq0}^{24} 1(t-LD=e)\beta_{e} + X_{ijdt} + \theta_{i} + \mu_{p} + \gamma_{t} + \epsilon_{ijtd}$$
where $SR_{ijtd}$ is species richness observed by user i on trip j on date t in district d. Each coefficient $\beta_{e}$ captures species richness relative to the day of lockdown (LD). In the preferred specification, LD = March 24, 2020 and this date is normalized to zero and omitted so that it describes the reference period. If the timing of lockdown is exogenous to pre-period outcomes, then $\beta_{e}$ should be zero for all $e<0$. $\theta_{i}$ is a user fixed effect and controls for ability. $\mu_{p}$ is a trip type fixed effect for stationary or travelling trips. Since users primarily remain in the same city before and after lockdown, we do not include a district fixed effect. $\gamma_{t}$ are a set of temporal controls and include date fixed effects and hour fixed effects. $X_{ijdt}$ is a vector of controls including trip duration and daily precipitation in district d. 


```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=12,fig.width=12}
stats <- data.frame()

# All Cities, 2 trips before/after
coefs <- event_study(ebird.d, user_fe=T)
coefs$type <- 'Cities: all, participation: 2 trips, LD: Mar 24'
stats <- rbind(stats, coefs)

# Top 20, 2 trips before/after
coefs <- event_study(ebird.d, num_cities = 20, user_fe=T)
coefs$type <- 'Cities: 20, participation: 2 trips, LD: Mar 24'
stats <- rbind(stats, coefs)

# Top 20, 5 trips before/after
coefs <- event_study(ebird.d, num_cities = 20, before = 5, after = 5, user_fe=T)
coefs$type <- 'Cities: 20, participation: 5 trips, LD: Mar 24'
stats <- rbind(stats, coefs)

# Top 20, 10 trips before/after
coefs <- event_study(ebird.d, num_cities = 20, before = 10, after = 10, user_fe=T)
coefs$type <- 'Cities: 20, participation: 10 trips, LD: Mar 24'
stats <- rbind(stats, coefs)

# Top 20, 2 trips before/after, Janta Curfew
ebird_janta <- filter(ebird, OBSERVATION.DATE <= '2020-04-13')
coefs <- event_study(ebird_janta, num_cities = 20, lockdown='2020-03-22', user_fe=T)
coefs$type <- 'Cities: 20, participation: 2 trips, LD: Mar 22'
stats <- rbind(stats, coefs)

ggplot(stats, aes(x=time, y=estimate, group=1)) + 
  geom_line() + 
  geom_point(aes(color='Coefficient')) +
  geom_ribbon(aes(ymin=conf.low, ymax=conf.high, fill='95% CI'), alpha=.5) +
  geom_vline(xintercept=0, linetype='dashed') +
  geom_hline(yintercept=0, linetype='dashed') +
  geom_text(aes(x=-2, label="Lockdown", y=2), angle=90) +
  ylab('Species Richness Relative to Lockdown\n') +
  xlab('\n Days to Lockdown') +
  scale_x_continuous(breaks = seq(-20, 30, by = 5)) +
  scale_colour_manual("" , values = "black") +
  scale_fill_manual("", values = "grey12") +
  theme(panel.grid.minor = element_blank(),
        text = element_text(size=13),
        axis.line = element_blank(), 
        axis.ticks = element_blank()) +
  facet_wrap(~type, scales='free', ncol=2)
```

## Species Distributions (Bangalore Only)
sample: stationary trips at home in both periods.
data: number of times each user sees each species before and after lockdown.
interpretation: proportion of user base seeing different frequencies of species.

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=100,fig.width=20, unit='in'}
stats <- ebird.d %>% 
  filter(PROTOCOL.TYPE == 'Stationary') %>%
  select_sample(home=T) %>%
  mutate(prepost = if_else(OBSERVATION.DATE <= '2020-03-24', 'PRE', 'POST'))

bangalore <- stats %>%
  filter(COUNTY == 'Bangalore') %>%
  fastDummies::dummy_cols(select_columns='COMMON.NAME') %>%
  group_by(OBSERVER.ID, prepost) %>%
  summarize_at(vars(starts_with('COMMON.NAME_')), sum, na.rm=T) %>%
  gather(species, number, starts_with('COMMON.NAME'))

ggplot(data = bangalore, 
       aes(x = number, 
           fill=prepost)) +
  geom_histogram(alpha=0.5, position="identity") +
  facet_wrap(~species, scales='free', ncol=4)

```

# Difference-in-Difference

In this specification, we aim to estimate the difference in species richness per trip before and after lockdown, compared to same difference in 2019. In other words, we subtract the change in 2019 (the counterfactual) from the 2020 lockdown effect to remove other determinants of species richness that are changing during the window. 

To do this, we first select 2020 users with at least 2 trips before and after lockdown. Then we select 2019 users with the same criteria, using March 24, 2019 as the threshold date. These are different users but share similar characteristics.

Formally, we specify the following standard DID regression:

$$ SR_{ijdt} = \beta_{1} [Treatment_{t} \times Post_{t}] + \beta_{2} [Treatment_{t}] + \beta_{3}[Post_{t}] + X_{ijdt} + \eta_{it} + \nu_{p} + \mu_{d} + \gamma_{t} + \epsilon_{ijdt} $$

Where $Treatment_{t}$ is a dummy for the year 2020 and $Post_{t}$ is a dummy equal to one for observations after March 24th. $\beta_{1}$ is the coefficient of interest and describes the change in species richness before and after March 19 in 2020 compared to the same difference in 2019. $\beta_{2}$ describes the difference in the "before" groups (pre-intervention). $\beta_{3}$ captures the time trend in the control (2019) group. $X_{ijdt}$ is a vector of controls including trip duration and rainfall. $\eta_{it}$ is a user-by-year fixed effect $\mu_{d}$ is a set of city fixed effects and $\gamma_{t}$ is a set of temporal controls including date and hour fixed effects. $\nu_{p}$ is trip type fixed effect and controls for the type of trip: stationary or travelling. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=8,fig.width=20}
# Visual Diff-in-diff
sample <- did(ebird_full, drop=F) %>%
  mutate(dif = ifelse(YEAR==2020, OBSERVATION.DATE - as.Date('2020-03-24'),
                      OBSERVATION.DATE - as.Date('2019-03-26')))

dd_all <- sample %>%
  group_by(dif, YEAR) %>%
  summarize(`Num. Species/Trip` = mean(s_richness, na.rm=T),
            `Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Users` = n_distinct(OBSERVER.ID)) %>%
  gather(var, value, starts_with('N')) %>%
  spread(YEAR, value) %>%
  mutate(All = `2020` - `2019`)

dd_type <- sample %>%
  group_by(dif, YEAR, PROTOCOL.TYPE) %>%
  summarize(`Num. Species/Trip` = mean(s_richness, na.rm=T),
            `Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Users` = n_distinct(OBSERVER.ID)) %>%
  gather(var, value, starts_with('N')) %>%
  pivot_wider(names_from=c(YEAR, PROTOCOL.TYPE), values_from=value) %>%
  mutate(Stationary = `2020_Stationary` - `2019_Stationary`,
         Travelling = `2020_Traveling` - `2019_Traveling`)

dd <- merge(dd_type, dd_all, by=c('dif', 'var')) %>%
  dplyr::select(dif, var, All, Stationary, Travelling) %>%
  #mutate(daymonth = factor(daymonth, ordered=TRUE)) %>%
  gather(key, value, c('All', 'Stationary', 'Travelling'))

ggplot(dd, aes(x=(dif), y=value, group=key)) +
  geom_line(aes(color=key)) + 
  labs(title = 'Difference in Daily Species Richness per User between 2020 and 2019', y='',
       x='Days since 4th Tuesday in March', color = 'Trip Type') +
  geom_vline(xintercept=0, linetype='dashed') +
  geom_hline(yintercept=0, linetype='dashed') +
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = c(-21, -14, -7, 0, 7, 14, 21),
                   labels= c('-21\n [1st Tues]', '-14\n[2nd Tues]', '-7\n[3rd Tues]', 
                             '0\n[4th Tues]','7\n[1st Tues]', '14\n[2nd Tues]', 
                             '21\n[3rd Tues]')) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(),
        text = element_text(size=15)) +
  facet_wrap(~var, scales='free')
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
models <- list()

sample <- did(ebird_full)
models[['All Cities']] <- lm(s_richness ~ TreatPost + Treatment + Post + 
                                        DURATION.MINUTES + rain + NUMBER.OBSERVERS +
                                        COUNTY + PROTOCOL.TYPE + weekend + HOUR, 
                                    data=sample, cluster="STATE")

sample <- did(ebird_full, num_cities=20)
models[['Top 20']] <- lm(s_richness ~ TreatPost + Treatment + Post + 
                                    DURATION.MINUTES + rain + NUMBER.OBSERVERS +
                                    COUNTY + PROTOCOL.TYPE + weekend + HOUR, 
                                  data=sample)

sample <- did(ebird_full, num_cities=20)
models[['Top 20 ']] <- lm(s_richness ~ TreatPost + Treatment + Post + 
                                    DURATION.MINUTES + rain + NUMBER.OBSERVERS +
                                    COUNTY + PROTOCOL.TYPE + 
                                    OBSERVER.ID:as.factor(YEAR) + weekend + HOUR, 
                                  data=sample)

sample <- did(ebird_full, num_cities=20, home=T)
models[['Top 20  ']] <- lm(s_richness ~ TreatPost + Treatment + Post + 
                                    DURATION.MINUTES + rain + NUMBER.OBSERVERS +
                                    COUNTY + PROTOCOL.TYPE + 
                                    OBSERVER.ID:as.factor(YEAR) + weekend + HOUR, 
                                  data=sample)

sample <- did(ebird_full, before=5, after=5, num_cities=20)
models[['Top 20    ']] <- lm(s_richness ~ TreatPost + Treatment + Post + 
                                    DURATION.MINUTES + rain + NUMBER.OBSERVERS +
                                    COUNTY + PROTOCOL.TYPE +
                                    OBSERVER.ID:as.factor(YEAR) + weekend + HOUR, 
                                  data=sample)

sample <- did(ebird_full, before=10, after=10, num_cities=20)
models[['Top 20      ']] <- lm(s_richness ~ TreatPost + Treatment + Post + 
                                    DURATION.MINUTES + rain + NUMBER.OBSERVERS +
                                    COUNTY + PROTOCOL.TYPE + 
                                    OBSERVER.ID:as.factor(YEAR) + weekend + HOUR, 
                                  data=sample)

msummary(models,
         title='Difference-in-Difference Estimates',
         stars=T,
         coef_map=c('TreatPost'='Treat x Post', 'Treatment'='Treatment', 'Post'='Post',
                    'rain'='Rainfall (mm)', 'NUMBER.OBSERVERS'='Group Size', 
                    'DURATION.MINUTES'='Duration'),
         gof_omit='AIC|BIC|Adj.R2|Log.Lik.',
         add_rows = list(c('Particip. Contstraint', 'None', '2 Trips', '2 Trips', '2 Trips', '5 Trips', '10 Trips'),
                         c('Home', 'No', 'No', 'No', 'Yes', 'No', 'No'),
                         c('District FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
                         c('Trip Type FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
                         c('Weekend FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
                         c('Hour Fe', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
                         c('User x Year Fe', 'No', 'No', 'Yes', 'Yes', 'Yes', 'Yes')),
         add_rows_location=0)

#cmap <- c('TreatPost'= 'Treat x Post', 'Post' = 'Post', 
#          'Treatment'='Treatment', 'DURATION.MINUTES'='Duration')
#msummary(models, coef_map=cmap, stars = T, 
#         title = "Diff-in-Diff Estimates")
```
