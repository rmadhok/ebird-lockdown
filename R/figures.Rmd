---
title: 'Manuscript Tables and Figures'
output: 
  html_document:
    number_sections: true
author: 'Raahil Madhok'
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir = '/Users/rmadhok/Dropbox (Personal)/covid/ebird_lockdown/data/')
```

```{r,include=F,warning=FALSE,message=FALSE}
# Load Packages
rm(list=ls())
require(tidyverse)
require(lubridate)
require(kableExtra)
require(lfe)
require(cowplot)
source('/Users/rmadhok/Dropbox (Personal)/covid/ebird_lockdown/scripts/R/select_functions.R')
```

# Overview
Sample selection protocol:

1. Stationary trips

2. Complete checklists (report all species)

3. Drop duplicates from group trips.

4. Drop trips with 1 bird

5. Duration between 5-240 mins

## Birdwatching Activity in All Cities
Summary Stats for 2020 in 1 month window around lockdown

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
ebird <- readRDS('ebd_full.rds')
ebird <- filter(ebird, YEAR == 2020) 

# Number of Users by day
stats <- select_sample(ebird, lockdown='2020-03-19')
stats <- stats %>%
  group_by(OBSERVATION.DATE) %>%
  summarize(`Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
  gather(key, value, starts_with('N'))

ggplot(stats, aes(x=OBSERVATION.DATE, y=value)) +
  geom_line() + 
  labs(title = 'Birdwatching Activity in all Cities', y='') +
  geom_vline(xintercept=as.numeric(as.Date("2020-03-19")), linetype='dashed') +
  scale_x_date(date_breaks = '10 days', date_labels = '%b\n%d') +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank()) +
  facet_wrap(~key, scales='free')
```

## Birdwatching Activity in Top 4 Cities
```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# By City
stats <- select_sample(ebird, num_cities = 20, lockdown = '2020-03-19')
stats <- filter(ebird, COUNTY %in% c('Mumbai', 'Bangalore', 'Chennai', 'Hyderabad'))
stats <- stats %>%
  group_by(COUNTY, OBSERVATION.DATE) %>%
  summarize(`Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
  gather(key, value, starts_with('N'))

ggplot(stats, aes(x=OBSERVATION.DATE, y=value)) +
  geom_line() +
  labs(title = 'Birdwatching Activity in Four Major Cities', y='') +
  geom_vline(xintercept=as.numeric(as.Date("2020-03-19")), linetype='dashed') +
  scale_x_date(date_breaks = '10 days', date_labels = '%b\n%d') +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank()) +
  facet_grid(COUNTY ~ key, scales='free')

```

## Top 20 Cities
This is the subset of eBird observations meeting the pariticipation criteria in the top 20 Indian cities by population size. Note that not all top 20 cities may be present in eBird. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
stats <- select_sample(ebird, num_cities = 20)
stats <- stats %>% 
  group_by(COUNTY) %>%
  summarize(STATE = first(STATE), POP_DENSITY = first(POP_DENSITY)) %>%
  arrange(-POP_DENSITY)
kable(stats, caption = 'eBird Cities in Top 20 by Population Density') %>% kable_styling()
```

## Pre-Post Lockdown Statistics
This table shows aggregate birdwatching activity in the full sample among users who birdwatched on at least 2 days before and after Junta lockdown (March 19, 2020). 

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# All Cities
stats <- select_sample(ebird)
stats <- stats %>%
  mutate(PREPOST = if_else(OBSERVATION.DATE < '2020-03-19', 'Pre-lockdown', 'Post-lockdown')) %>%
  group_by(PREPOST) %>%
  summarize(`Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Cities` = n_distinct(COUNTY),
            `Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER))

kable(stats, caption = 'All Cities') %>% kable_styling()

# Top 20
stats <- select_sample(ebird, num_cities = 20)
stats <- stats %>%
  mutate(PREPOST = if_else(OBSERVATION.DATE < '2020-03-19', 'Pre-lockdown', 'Post-lockdown')) %>%
  group_by(PREPOST) %>%
  summarize(`Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
            `Num. Cities` = n_distinct(COUNTY),
            `Num. Users` = n_distinct(OBSERVER.ID),
            `Num. Species` = n_distinct(TAXONOMIC.ORDER))

kable(stats, caption = 'Top 20') %>% kable_styling()
```

## Trip Statistics
This table shows trip-level statistics before and after lockdown.

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}

# Full Sample
stats <- select_sample(ebird)
stats <- stats %>%  
  distinct(SAMPLING.EVENT.IDENTIFIER, .keep_all = T) %>%
  dplyr::select(OBSERVATION.DATE, SAMPLING.EVENT.IDENTIFIER, 
                DURATION.MINUTES, s_richness, COUNTY) %>%
  mutate(PREPOST = if_else(OBSERVATION.DATE < '2020-03-19', 'Pre-lockdown', 'Post-lockdown')) %>%
  group_by(PREPOST) %>%
  summarize(`Trip Length` = mean(DURATION.MINUTES),
            `Mean Species Richness` = mean(s_richness, na.rm=T),
            `Median Species Richness` = median(s_richness, na.rm=T))

kable(stats, caption='All Cities') %>% kable_styling()

# Top 20
stats <- select_sample(ebird, num_cities = 20)
stats <- stats %>%  
  distinct(SAMPLING.EVENT.IDENTIFIER, .keep_all = T) %>%
  dplyr::select(OBSERVATION.DATE, SAMPLING.EVENT.IDENTIFIER, 
                DURATION.MINUTES, s_richness, COUNTY) %>%
  mutate(PREPOST = if_else(OBSERVATION.DATE < '2020-03-19', 'Pre-lockdown', 'Post-lockdown')) %>%
  group_by(PREPOST) %>%
  summarize(`Trip Length` = mean(DURATION.MINUTES),
            `Mean Species Richness` = mean(s_richness, na.rm=T),
            `Median Species Richness` = median(s_richness, na.rm=T))

kable(stats, caption='Top 20') %>% kable_styling()

# By City
stats <- select_sample(ebird, num_cities = 20)
stats <- stats %>%  
  distinct(SAMPLING.EVENT.IDENTIFIER, .keep_all = T) %>%
  dplyr::select(OBSERVER.ID, OBSERVATION.DATE, SAMPLING.EVENT.IDENTIFIER, 
                DURATION.MINUTES, s_richness, COUNTY) %>%
  mutate(PREPOST = if_else(OBSERVATION.DATE < '2020-03-19', 'Before', 'After')) %>%
  group_by(COUNTY, PREPOST) %>%
  summarize(`Trip Length` = mean(DURATION.MINUTES),
            `Mean Species Richness` = mean(s_richness, na.rm=T),
            `Median Species Richness` = median(s_richness, na.rm=T)) %>%
  filter(COUNTY!='Central Delhi')

ggplot(stats, aes(x=factor(PREPOST), y=`Mean Species Richness`)) + 
  geom_bar(stat = 'identity') + 
  scale_x_discrete(limits=c('Before','After')) +
  labs(title = 'Mean Species Richness Per Trip') +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks = element_blank()) +
  facet_wrap(~COUNTY, scales = 'free')
```

## Marginal Species by city
Marginal species are species observed after lockdown which were not observed before lockdown. To implement: in each city, obtain list of species observed (across all users) in March and April 2020. Extract species in april list not in march list, and collect in a data frame. If fewer species in april, city will not be in final list. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Species List
stats <- select_sample(ebird, num_cities = 20) %>%
  mutate(prepost = if_else(OBSERVATION.DATE < '2020-03-19', 'PRE', 'POST'))
city_list <- distinct(stats, COUNTY)$COUNTY
marginal_species <- data.frame()

# stack Marginal Species per city
for(city in city_list) {
  
  df_pre <- stats %>%
    filter(COUNTY == city & prepost == 'PRE') %>%
    distinct(COMMON.NAME, .keep_all = T) %>%
    select('COMMON.NAME', 'SCIENTIFIC.NAME', 'COUNTY')

  df_post <- stats %>%
    filter(COUNTY == city & prepost == 'POST') %>%
    distinct(COMMON.NAME, .keep_all = T) %>%
    select('COMMON.NAME', 'SCIENTIFIC.NAME', 'COUNTY')
  
  marginal <- anti_join(df_post, df_pre, by='COMMON.NAME')
  marginal_species <- rbind(marginal_species, marginal)
}

kable(marginal_species) %>%
  kable_styling(fixed_thead = T)
rm(list=c('city_list', 'df_post', 'df_pre', 'marginal'))
```

# Event Study - Regression Disconinuity
Each black point is the difference in species richness compared to the day of lockdown. 
Specifically, we compute the number of days from each trip until the day of lockdown (negative values are days until lockdown, positive values are days after lockdown). We regress species richness on dummies for time until lockdown with date, hour, and state fixed effects. We also control for duration of trip and number of trips per day for each user. 


Notes: 

1. We see action around Janta curfew, not as much around official lockdown. Suggests people responded to the former. 

2. We start seeing increases in species diversity post-lockdown when we narrow in on urban environments

3. Larger increases in post-lockdown species diversity as we increase the participation constraint (e.g. 10 days before/after curfew)


```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=20,fig.width=12}
stats <- data.frame()

# All Cities, 2 days before/after
coefs <- event_study(ebird)
coefs$type <- 'Cities: all, participation: 2 days, LD: Mar 19'
stats <- rbind(stats, coefs)

# All Cities, 2 days before/after, March 24
#coefs <- event_study(ebird, lockdown = '2020-03-24')
#coefs$type <- 'Cities: all, 2 days pre/post, Mar 24'
#stats <- rbind(stats, coefs)

# Top 20, 2 days before/after
coefs <- event_study(ebird, num_cities = 20)
coefs$type <- 'Cities: 20, participation: 2 days, LD: Mar 19'
stats <- rbind(stats, coefs)

# Top 20, 2 days before/after, March 24
#coefs <- event_study(ebird, num_cities = 20, lockdown = '2020-03-24')
#coefs$type <- 'Top 20 Cities, 2 days pre/post, Mar 24'
#stats <- rbind(stats, coefs)

# Top 20, 5 days before/after
coefs <- event_study(ebird, num_cities = 20, before = 5, after = 5)
coefs$type <- 'Cities: 20, participation: 5 days, LD: Mar 19'
stats <- rbind(stats, coefs)

# Top 20, 5 days before/after, March 24
#coefs <- event_study(ebird, num_cities = 20, before = 5, after = 5, 
#                     lockdown = '2020-03-24', user_fe=T)
#coefs$type <- 'Top 20 Cities, 5 days pre/post, Mar 24'
#stats <- rbind(stats, coefs)

# Top 20, 10 days before/after
coefs <- event_study(ebird, num_cities = 20, before = 10, after = 10)
coefs$type <- 'Cities: 20, participation: 10 days, LD: Mar 19'
stats <- rbind(stats, coefs)

# Top 20, 10 days before/after, March 24
#coefs <- event_study(ebird, num_cities = 20, before = 10, after = 10, 
#                     lockdown = '2020-03-24', user_fe=T)
#coefs$type <- 'Top 20 Cities, 10 days pre/post, Mar 24'
#stats <- rbind(stats, coefs)

# Top 50, 5 days before/after
coefs <- event_study(ebird, num_cities = 50, before = 5, after = 5)
coefs$type <- 'Citiess: 50, participation: 5 days, LD: Mar 19'
stats <- rbind(stats, coefs)

# Top 50, 5 days before/after, March 24
coefs <- event_study(ebird, num_cities = 50, before = 5, after = 5, 
                     lockdown = '2020-03-24')
coefs$type <- 'Cities: 50, participation: 5 days, LD: Mar 24'
stats <- rbind(stats, coefs)

ggplot(stats, aes(x=time, y=estimate, group=1)) + 
  geom_line() + 
  geom_point(aes(color='Coefficient')) +
  geom_ribbon(aes(ymin=conf.low, ymax=conf.high, fill='95% CI'), alpha=.5) +
  geom_vline(xintercept=0, linetype='dashed') +
  geom_hline(yintercept=0, linetype='dashed') +
  geom_text(aes(x=-2, label="Lockdown", y=2), angle=90) +
  ylab('Species Richness Relative to Lockdown\n') +
  xlab('\n Days to Lockdown') +
  scale_x_continuous(breaks = seq(-20, 30, by = 5)) +
  scale_colour_manual("" , values = "black") +
  scale_fill_manual("", values = "grey12") +
  theme(panel.grid.minor = element_blank(),
        text = element_text(size=13),
        axis.line = element_blank(), 
        axis.ticks = element_blank()) +
  facet_wrap(~type, scales='free', ncol=2)
```

## Species Distributions (Bangalore Only)
data: number of times each user sees each species in march and april.
interpretation: proportion of user base seeing different frequencies of species.

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=100,fig.width=20, unit='in'}
stats <- select_sample(ebird) %>%
  mutate(prepost = if_else(OBSERVATION.DATE < '2020-03-19', 'PRE', 'POST'))

bangalore <- stats %>%
  filter(COUNTY == 'Bangalore') %>%
  fastDummies::dummy_cols(select_columns='COMMON.NAME') %>%
  group_by(OBSERVER.ID, prepost) %>%
  summarize_at(vars(starts_with('COMMON.NAME_')), sum, na.rm=T) %>%
  gather(species, number, starts_with('COMMON.NAME'))

ggplot(data = bangalore, 
       aes(x = number, 
           fill=prepost)) +
  geom_histogram(alpha=0.5, aes(y=..density..), position="identity") +
  facet_wrap(~species, ncol=4)

```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}

#trip_level$treatment <- as.numeric(trip_level$YEAR == 2020)
#trip_level$MONTH <- month(trip_level$OBSERVATION.DATE)
#trip_level$post <- as.numeric(trip_level$MONTH == 4)
#trip_level$treat_post <- trip_level$treatment*trip_level$post

#est <- lm(s_richness ~ treat_post + treatment + post + DURATION.MINUTES + n_trips_day + 
#            c_code_11 + OBSERVATION.DATE + hour, data=trip_level)

```
