# --------------------------------------------------------------
# Load Data
# --------------------------------------------------------------
# District shapefiles
india_dist <- readOGR(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F)
rstack <- stack(paste(READ.DIR, 'temp-era-2020.nc', sep=''))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct weather data
# AUTHOR: Raahil Madhok
# DATE: Jun 2 2020 [created]
# Directories
rm(list=ls())
READ.DIR <- '/Volumes/Backup Plus/research/ebird_lockdown/weather/temp_era/'
SAVE.DIR <- '/Users/rmadhok/Dropbox (Personal)/covid/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
# Packages
require(raster)
require(rgdal)
require(sp)
require(tidyverse)
# --------------------------------------------------------------
# Load Data
# --------------------------------------------------------------
# District shapefiles
india_dist <- readOGR(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F)
# --------------------------------------------------------------
# Process
# --------------------------------------------------------------
# Iterate through variables
# Read NetCDF Var (hourly data)
rstack <- stack(paste(READ.DIR, 'temp-era-2020.nc', sep=''))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct weather data
# AUTHOR: Raahil Madhok
# DATE: Jun 2 2020 [created]
# Directories
rm(list=ls())
READ.DIR <- '/Volumes/Backup Plus/research/ebird_lockdown/weather/era_temp/'
SAVE.DIR <- '/Users/rmadhok/Dropbox (Personal)/covid/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
# Packages
require(raster)
require(rgdal)
require(sp)
require(tidyverse)
# --------------------------------------------------------------
# Load Data
# --------------------------------------------------------------
# District shapefiles
india_dist <- readOGR(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F)
# --------------------------------------------------------------
# Process
# --------------------------------------------------------------
# Iterate through variables
# Read NetCDF Var (hourly data)
rstack <- stack(paste(READ.DIR, 'temp-era-2020.nc', sep=''))
rstack <- stack(paste(READ.DIR, 'temp-era-2019.nc', sep=''))
rstack <- raster(paste(READ.DIR, 'temp-era-2019.nc', sep=''))
paste(READ.DIR, 'temp-era-2019.nc', sep='')
rstack <- raster(paste(READ.DIR, 'temp-era-2019.nc', sep=''))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct weather data
# AUTHOR: Raahil Madhok
# DATE: Jun 2 2020 [created]
# Directories
rm(list=ls())
READ.DIR <- '/Volumes/Backup Plus 1/research/ebird_lockdown/weather/era_temp/'
SAVE.DIR <- '/Users/rmadhok/Dropbox (Personal)/covid/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
# Packages
require(raster)
require(rgdal)
require(sp)
require(tidyverse)
# --------------------------------------------------------------
# Load Data
# --------------------------------------------------------------
# District shapefiles
india_dist <- readOGR(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F)
# --------------------------------------------------------------
# Process
# --------------------------------------------------------------
# Iterate through variables
# Read NetCDF Var (hourly data)
rstack <- raster(paste(READ.DIR, 'adaptor.mars.internal-1592582916.1444337-20250-7-a0ccc905-6f8a-40e4-b82d-27422fca97fd.nc', sep=''))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct weather data
# AUTHOR: Raahil Madhok
# DATE: Jun 2 2020 [created]
# Directories
rm(list=ls())
READ.DIR <- '/Volumes/Backup Plus 1/research/ebird_lockdown/weather/era_temp/'
SAVE.DIR <- '/Users/rmadhok/Dropbox (Personal)/covid/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
# Packages
require(raster)
require(rgdal)
require(sp)
require(tidyverse)
# --------------------------------------------------------------
# Load Data
# --------------------------------------------------------------
# District shapefiles
india_dist <- readOGR(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F)
# --------------------------------------------------------------
# Process
# --------------------------------------------------------------
# Iterate through variables
# Read NetCDF Var (hourly data)
rstack <- stack(paste(READ.DIR, 'adaptor.mars.internal-1592582916.1444337-20250-7-a0ccc905-6f8a-40e4-b82d-27422fca97fd.nc', sep=''))
rstack
india_dist
india_dist <- spTransform(india_dist, rstack@crs) # sync projections
rstack <- crop(rstack, extent(india_dist))
df <- raster::extract(rstack, india_dist,
fun = mean, na.rm = T, sp=T)@data
df_long <- df %>% gather(time, value, starts_with('X20')) %>%
select('STATE_UT', 'NAME', 'c_code_11', 'time', 'value') %>%
mutate(date = substr(time, 2, 11),
date = stringr::str_replace_all(date, '\\.', '-'))
View(df_long)
df_long <- df_long %>%
group_by(c_code_11, date) %>%
summarize(STATE = first(STATE_UT),
NAME = first(NAME),
value = mean(value, na.rm=T))
View(df_long)
require("knitr")
opts_knit$set(root.dir = '/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/data/')
# Load Packages
rm(list=ls())
require(tidyverse)
require(kableExtra)
require(lfe)
require(modelsummary)
source('/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/scripts/R/select_functions.R')
# Read
ebird_full <- readRDS('ebd_full.rds')
# 24 days before and after lockdown (Mar 24 2020)
ebird <- ebird_full[ebird_full$YEAR == 2020 &
ebird_full$OBSERVATION.DATE <= '2020-04-17',]
# Usage by Day
stats <- ebird %>%
group_by(OBSERVATION.DATE, PROTOCOL.TYPE) %>%
summarize(`Num. Users` = n_distinct(OBSERVER.ID),
`Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
`Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
gather(key, value, starts_with('N'))
ggplot(stats, aes(x=OBSERVATION.DATE, y=value, group=PROTOCOL.TYPE)) +
geom_line(aes(color=PROTOCOL.TYPE)) +
labs(title = 'Birdwatching Activity in all Cities (2020)', y='') +
geom_vline(xintercept=as.numeric(as.Date("2020-03-24")), linetype='dashed') +
scale_x_date(date_breaks = '10 days', date_labels = '%b\n%d') +
scale_colour_viridis_d() +
labs(color='Trip Type') +
theme_bw() +
theme(panel.grid.minor = element_blank(),
axis.line = element_blank(),
axis.title.x = element_blank()) +
facet_wrap(~key, scales='free')
# By City
stats <- ebird %>%
group_by(COUNTY, OBSERVATION.DATE, PROTOCOL.TYPE) %>%
summarize(`Num. Users` = n_distinct(OBSERVER.ID),
`Num. Trips` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
`Num. Species` = n_distinct(TAXONOMIC.ORDER)) %>%
gather(key, value, starts_with('N'))
stats <- filter(stats, COUNTY %in% c('Mumbai', 'Bangalore', 'Chennai', 'Kolkata'))
ggplot(stats, aes(x=OBSERVATION.DATE, y=value, group=PROTOCOL.TYPE)) +
geom_line(aes(color=PROTOCOL.TYPE)) +
labs(title = 'Birdwatching Activity in Four Major Cities (2020)', y='') +
geom_vline(xintercept=as.numeric(as.Date("2020-03-24")), linetype='dashed') +
scale_x_date(date_breaks = '10 days', date_labels = '%b\n%d') +
scale_colour_viridis_d() +
labs(color='Trip Type') +
theme_bw() +
theme(panel.grid.minor = element_blank(),
axis.line = element_blank(),
axis.title.x = element_blank()) +
facet_wrap(~COUNTY+key, scales='free', ncol=3)
ebird.d <- filter(ebird, OBSERVATION.DATE != '2020-03-22')
stats <- ebird.d %>%
select_sample(num_cities = 20) %>%
group_by(COUNTY) %>%
summarize(STATE = first(STATE), POP_DENSITY = first(POP_DENSITY)) %>%
arrange(-POP_DENSITY)
kable(stats,
caption = 'Subset of Top 20 Cities where power users present') %>%
kable_styling()
models <- list()
sample <- did(ebird_full)
models[['All Cities']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20)
models[['Top 20']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20)
models[['Top 20 ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20, home=T)
models[['Top 20 ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, before=5, after=5, num_cities=20)
models[['Top 20   ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, before=10, after=10, num_cities=20)
models[['Top 20    ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
msummary(models,
title='Difference-in-Difference Estimates',
stars=T,
coef_map=c('TreatPost'='Treat x Post', 'Treatment'='Treatment', 'Post'='Post',
'DURATION.MINUTES'='Duration'),
gof_omit='AIC|BIC|Adj.R2|Log.Lik.',
add_rows = list(c('Particip. Contstraint', 'None', '2 Trips', '2 Trips', '5 Trips', '10 Trips'),
c('Home', 'No', 'No', 'No', 'Yes', 'No', 'No', 'No'),
c('District FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Trip Type FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Weekend FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Hour Fe', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('User x Year Fe', 'No', 'No', 'Yes', 'Yes', 'Yes', 'Yes')),
add_rows_location=0)
msummary(models,
title='Difference-in-Difference Estimates',
stars=T,
coef_map=c('TreatPost'='Treat x Post', 'Treatment'='Treatment', 'Post'='Post',
'DURATION.MINUTES'='Duration'),
gof_omit='AIC|BIC|Adj.R2|Log.Lik.',
add_rows = list(c('Particip. Contstraint', 'None', '2 Trips', '2 Trips', '2 Trips', '5 Trips', '10 Trips'),
c('Home', 'No', 'No', 'No', 'Yes', 'No', 'No'),
c('District FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Trip Type FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Weekend FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Hour Fe', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('User x Year Fe', 'No', 'No', 'Yes', 'Yes', 'Yes', 'Yes')),
add_rows_location=0)
models <- list()
sample <- did(ebird_full)
models[['All Cities']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20)
models[['Top 20']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20)
models[['Top 20 ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20, home=T)
models[['Top 20 ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, before=5, after=5, num_cities=20)
models[['Top 20   ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, before=10, after=10, num_cities=20)
models[['Top 20    ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
msummary(models,
title='Difference-in-Difference Estimates',
stars=T,
coef_map=c('TreatPost'='Treat x Post', 'Treatment'='Treatment', 'Post'='Post',
'DURATION.MINUTES'='Duration'),
gof_omit='AIC|BIC|Adj.R2|Log.Lik.',
add_rows = list(c('Particip. Contstraint', 'None', '2 Trips', '2 Trips', '2 Trips', '5 Trips', '10 Trips'),
c('Home', 'No', 'No', 'No', 'Yes', 'No', 'No'),
c('District FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Trip Type FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Weekend FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Hour Fe', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('User x Year Fe', 'No', 'No', 'Yes', 'Yes', 'Yes', 'Yes')),
add_rows_location=0)
models <- list()
sample <- did(ebird_full)
models[['All Cities']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20)
models[['Top 20']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20)
models[['Top 20 ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, num_cities=20, home=T)
models[['Top 20  ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, before=5, after=5, num_cities=20)
models[['Top 20    ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
sample <- did(ebird_full, before=10, after=10, num_cities=20)
models[['Top 20      ']] <- lm(s_richness ~ TreatPost + Treatment + Post +
DURATION.MINUTES + rain +
COUNTY + PROTOCOL.TYPE +
OBSERVER.ID:as.factor(YEAR) + weekend + HOUR,
data=sample)
msummary(models,
title='Difference-in-Difference Estimates',
stars=T,
coef_map=c('TreatPost'='Treat x Post', 'Treatment'='Treatment', 'Post'='Post',
'DURATION.MINUTES'='Duration'),
gof_omit='AIC|BIC|Adj.R2|Log.Lik.',
add_rows = list(c('Particip. Contstraint', 'None', '2 Trips', '2 Trips', '2 Trips', '5 Trips', '10 Trips'),
c('Home', 'No', 'No', 'No', 'Yes', 'No', 'No'),
c('District FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Trip Type FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Weekend FE', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('Hour Fe', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes', 'Yes'),
c('User x Year Fe', 'No', 'No', 'Yes', 'Yes', 'Yes', 'Yes')),
add_rows_location=0)
#cmap <- c('TreatPost'= 'Treat x Post', 'Post' = 'Post',
#          'Treatment'='Treatment', 'DURATION.MINUTES'='Duration')
#msummary(models, coef_map=cmap, stars = T,
#         title = "Diff-in-Diff Estimates")
length(unique(ebird_full$SAMPLING.EVENT.IDENTIFIER))
length(unique(ebird_full$OBSERVER.ID))
length(unique(ebird_full$TAXONOMIC.ORDER))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct final data
# AUTHOR: Raahil Madhok
# DATE: May 21 2020 [created]
# Directories
rm(list=ls())
DIR <- '/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
setwd(DIR)
# Load Packages
require(tidyverse)
require(sf)
require(lubridate)
# 1. Read data -------------------------------
# Load (n=1,586,974)
ebird <- as.data.frame(readRDS('ebd_lockdown_raw.rds'))
length(unique(ebird$OBSERVER.ID))
length(unique(ebird$SAMPLING.EVENT.IDENTIFIER))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct final data
# AUTHOR: Raahil Madhok
# DATE: May 21 2020 [created]
# Directories
rm(list=ls())
DIR <- '/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
setwd(DIR)
# Load Packages
require(tidyverse)
require(sf)
require(lubridate)
# 1. Read data -------------------------------
# Load (n=1,586,974)
ebird <- as.data.frame(readRDS('ebd_lockdown_raw.rds'))
# district shapefile
india_districts <- st_read(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F) %>%
select('c_code_11', 'TOT_POP', 'TOT_AREA', 'NAME', 'geometry') %>%
mutate(POP_DENSITY = TOT_POP / TOT_AREA)
# 2. Filter eBird -------------------------------
# a. Stationary trips
ebd_use <- filter(ebird, PROTOCOL.TYPE == 'Stationary' | PROTOCOL.TYPE == 'Traveling') # n=572,605
# b. Complete checklists (# n = 564,547)
ebd_use <- filter(ebd_use, ALL.SPECIES.REPORTED == 1)
# c. Drop Duplicates from group trips (n=499,915)
ebd_use$GROUP.IDENTIFIER[ebd_use$GROUP.IDENTIFIER == ''] <- NA
ebd_m <- ebd_use %>% filter(is.na(GROUP.IDENTIFIER))
ebd_nm <- ebd_use %>% filter(!is.na(GROUP.IDENTIFIER))
ebd_dd <- distinct(ebd_nm, GROUP.IDENTIFIER, TAXONOMIC.ORDER, .keep_all = T)
ebd_use <- rbind(ebd_m, ebd_dd)
rm(list=c('ebd_dd', 'ebd_m', 'ebd_nm'))
# d. Duration b/w 5-240 mins (see Callaghan et al. 2019) n=483,426
ebd_use <- filter(ebd_use, DURATION.MINUTES >= 5 & DURATION.MINUTES <= 240)
# 3. Species Diversity -------------------------------
#ebd_use$OBSERVATION.COUNT[ebd_use$OBSERVATION.COUNT == 'X'] <- NA
#ebd_use$OBSERVATION.COUNT <- as.numeric(ebd_use$OBSERVATION.COUNT)
# Species diveristy per trip
ebd_use <- ebd_use %>%
group_by(SAMPLING.EVENT.IDENTIFIER) %>%
mutate(s_richness = n())
# e. Drop if checklist has 1 bird (see Walker & Tayler, 2017) n=482,047
ebd_use <- as.data.frame(filter(ebd_use, s_richness > 1))
# Keep selected columns
ebd_use <- select(ebd_use, 'TAXONOMIC.ORDER', 'COMMON.NAME', 'SCIENTIFIC.NAME',
'OBSERVATION.COUNT', 'STATE', 'COUNTY', 'LOCALITY', 'LOCALITY.TYPE',
'LATITUDE', 'LONGITUDE', 'OBSERVATION.DATE', 'TIME.OBSERVATIONS.STARTED',
'OBSERVER.ID', 'SAMPLING.EVENT.IDENTIFIER', 'DURATION.MINUTES',
'NUMBER.OBSERVERS', 'GROUP.IDENTIFIER', 'YEARMONTH', 'YEAR', 'HOUR',
'PROTOCOL.TYPE','n_trips_pld', 's_richness')
# Week Dummy
ebd_use <- ebd_use %>%
mutate(month = format(OBSERVATION.DATE, '%B'),
dow = weekdays(OBSERVATION.DATE),
weekend = as.numeric(dow %in% c('Saturday', 'Sunday')),
week = isoweek(OBSERVATION.DATE),
day_week = paste(month, ', ', dow, ', week ', week, sep=''))
# 2. Overlay District -------------------------
# Spatial merge census code and population
ebd_use <- as.data.frame(st_join(st_as_sf(ebd_use,
coords = c('LONGITUDE', 'LATITUDE'),
crs = 4326),
india_districts, join = st_intersects))
na_code <- filter(ebd_use, is.na(c_code_11))
length(unique(na_code$SAMPLING.EVENT.IDENTIFIER))
ebd_use <- filter(ebd_use, !is.na(c_code_11))
# PROJECT: Nature in Lockdown
# PURPOSE: Construct final data
# AUTHOR: Raahil Madhok
# DATE: May 21 2020 [created]
# Directories
rm(list=ls())
DIR <- '/Users/rmadhok/Dropbox (Personal)/ebird_lockdown/data/'
SHP <- '/Users/rmadhok/Dropbox (Personal)/IndiaPowerPlant/data/'
setwd(DIR)
# Load Packages
require(tidyverse)
require(sf)
require(lubridate)
# 1. Read data -------------------------------
# Load (n=1,586,974)
ebird <- as.data.frame(readRDS('ebd_lockdown_raw.rds'))
# district shapefile
india_districts <- st_read(paste(SHP, "maps/india-district", sep=""),
'SDE_DATA_IN_F7DSTRBND_2011',
stringsAsFactors = F) %>%
select('c_code_11', 'TOT_POP', 'TOT_AREA', 'NAME', 'geometry') %>%
mutate(POP_DENSITY = TOT_POP / TOT_AREA)
# 2. Filter eBird -------------------------------
# a. Stationary trips
ebd_use <- filter(ebird, PROTOCOL.TYPE == 'Stationary' | PROTOCOL.TYPE == 'Traveling') # n=572,605
ebd_use <- filter(ebd_use, ALL.SPECIES.REPORTED == 1)
ebd_use$GROUP.IDENTIFIER[ebd_use$GROUP.IDENTIFIER == ''] <- NA
ebd_m <- ebd_use %>% filter(is.na(GROUP.IDENTIFIER))
ebd_nm <- ebd_use %>% filter(!is.na(GROUP.IDENTIFIER))
ebd_dd <- distinct(ebd_nm, GROUP.IDENTIFIER, TAXONOMIC.ORDER, .keep_all = T)
ebd_use <- rbind(ebd_m, ebd_dd)
rm(list=c('ebd_dd', 'ebd_m', 'ebd_nm'))
ebd_use <- filter(ebd_use, DURATION.MINUTES >= 5 & DURATION.MINUTES <= 240)
# Species diveristy per trip
ebd_use <- ebd_use %>%
group_by(SAMPLING.EVENT.IDENTIFIER) %>%
mutate(s_richness = n())
# e. Drop if checklist has 1 bird (see Walker & Tayler, 2017) n=482,047
ebd_use <- as.data.frame(filter(ebd_use, s_richness > 1))
ebd_use <- select(ebd_use, 'TAXONOMIC.ORDER', 'COMMON.NAME', 'SCIENTIFIC.NAME',
'OBSERVATION.COUNT', 'STATE', 'COUNTY', 'LOCALITY', 'LOCALITY.TYPE',
'LATITUDE', 'LONGITUDE', 'OBSERVATION.DATE', 'TIME.OBSERVATIONS.STARTED',
'OBSERVER.ID', 'SAMPLING.EVENT.IDENTIFIER', 'DURATION.MINUTES',
'NUMBER.OBSERVERS', 'GROUP.IDENTIFIER', 'YEARMONTH', 'YEAR', 'HOUR',
'PROTOCOL.TYPE','n_trips_pld', 's_richness')
ebd_use <- ebd_use %>%
mutate(month = format(OBSERVATION.DATE, '%B'),
dow = weekdays(OBSERVATION.DATE),
weekend = as.numeric(dow %in% c('Saturday', 'Sunday')),
week = isoweek(OBSERVATION.DATE),
day_week = paste(month, ', ', dow, ', week ', week, sep=''))
ebd_use <- as.data.frame(st_join(st_as_sf(ebd_use,
coords = c('LONGITUDE', 'LATITUDE'),
crs = 4326),
india_districts, join = st_intersects))
ebd_use <- filter(ebd_use, !is.na(c_code_11))
name_na <- filter(ebd_use, COUNTY == "")
length(uniqe(ebd_use$SAMPLING.EVENT.IDENTIFIER))
length(unique(name_na$SAMPLING.EVENT.IDENTIFIER))
